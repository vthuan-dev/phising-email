# Phishing Email Detection Pipeline with Google Gemini

## Overview

A comprehensive end-to-end phishing email detection system powered by Google Gemini AI, integrated into an ELK stack for real-time monitoring, visualization, and alerting.

```
┌─────────────────┐    ┌──────────────┐    ┌─────────────┐
│   Email Agent   │───▶│   JSON Logs  │───▶│  Filebeat   │
│  (Gemini AI)    │    │  (Rotating)  │    │             │
└─────────────────┘    └──────────────┘    └─────────────┘
                                                 │
                                                 ▼
┌─────────────────┐    ┌──────────────┐    ┌─────────────┐
│    Kibana       │◀───│Elasticsearch │◀───│  Logstash   │
│  (Dashboard +   │    │  (Storage +  │    │ (Processing)│
│   Alerting)     │    │   Indexing)  │    │             │
└─────────────────┘    └──────────────┘    └─────────────┘
                              │
                              ▼
                       ┌─────────────┐
                       │ ElastAlert  │
                       │ (Email/Slack│
                       │  Alerts)    │
                       └─────────────┘
```

## Features

- **Google Gemini AI**: Advanced phishing detection using Gemini 1.5 Flash model
- **Multiple Input Modes**: Local files (.eml/.txt) or live IMAP email fetching
- **PII Protection**: Automatic redaction of emails, phones, and sensitive data
- **Real-time Processing**: Filebeat → Logstash → Elasticsearch pipeline
- **Rich Visualization**: Kibana dashboards with ML vs LLM comparison
- **Smart Alerting**: ElastAlert rules combining ML scores, LLM confidence, and heuristics
- **Containerized**: Full Docker Compose setup with health checks

## Quick Start

1. **Clone and setup environment**:
   ```bash
   git clone <repository>
   cd phishing-detection
   cp .env.example .env
   # Edit .env with your credentials
   ```

2. **Build and start services**:
   ```bash
   make build
   make train
   make up
   ```

3. **Generate sample data**:
   ```bash
   make sample-data
   ```

4. **Access interfaces**:
   - Kibana: http://localhost:5601
   - Elasticsearch: http://localhost:9200
   - API: http://localhost:8000

5. **Run email agent**:
   ```bash
   # Process sample files
   make agent
   
   # Or with LLM mode
   MODE=hybrid make agent
   ```

## Configuration

### Email Processing Modes

- **`classic`**: Classical ML only (fast, offline)
- **`llm`**: LLM only (slower, requires API key)
- **`hybrid`**: Both ML and LLM scoring (recommended)

### Environment Variables

Key settings in `.env`:

```bash
# Processing mode
MODE=hybrid

# OpenAI (for LLM mode)
OPENAI_API_KEY=your_key
OPENAI_MODEL=gpt-4o-mini

# IMAP (for live email)
IMAP_HOST=imap.gmail.com
IMAP_USER=your_email@gmail.com
IMAP_PASS=your_app_password

# Alerting
ALERT_EMAIL=security@company.com
SLACK_WEBHOOK=https://hooks.slack.com/...
```

## Training Custom Models

1. **Prepare your dataset**: CSV with columns `subject`, `body`, `label` (phishing/legit)

2. **Train model**:
   ```bash
   DATA_PATH=/path/to/your/emails.csv make train
   ```

3. **Artifacts**: Generated `vectorizer.pkl` and `model.pkl` in `ml/artifacts/`

## LLM Integration

### Cost and Latency Notes

- **GPT-4o-mini**: ~$0.0015 per 1K tokens, ~500ms latency
- **GPT-4o**: ~$0.03 per 1K tokens, ~800ms latency
- **Caching**: SHA256-based to avoid duplicate calls
- **Rate limiting**: Configurable (default: 10 req/min)

### Privacy Features

- Email addresses → `[EMAIL_REDACTED]`
- Phone numbers → `[PHONE_REDACTED]`
- Body truncation to 2000 chars
- Sender hashing for analytics

## Alerting Rules

Triggers on:
- ML score ≥ 0.85 OR
- LLM confidence ≥ 0.85 OR
- (ML score ≥ 0.6 OR LLM confidence ≥ 0.6) AND suspicious keywords ≥ 2 OR
- URL in blacklist

## API Endpoints

- `GET /health` - Service health check
- `POST /score` - Score email content
- `GET /metrics` - Processing metrics

## Development

### Run Tests
```bash
make test
```

### Gradio Demo (LLM testing)
```bash
make gradio
# Visit http://localhost:7860
```

### View Logs
```bash
make logs
# Or specific service
make logs-agent
```

## Troubleshooting

See `docs/runbook.md` for detailed troubleshooting guide covering:
- Docker memory issues
- Elasticsearch bootstrap checks
- Logstash pipeline errors
- Filebeat permissions
- ElastAlert authentication

## Security

See `SECURITY.md` for security considerations including:
- PII redaction strategies
- Secret management
- LLM data minimization
- Network security

## Architecture

### Data Flow

1. **Email Collection**: Agent reads emails via IMAP or local files
2. **Feature Extraction**: Headers, URLs, keywords, body excerpts
3. **ML Classification**: TF-IDF vectorization → Linear SVC → calibrated score
4. **LLM Augmentation**: Optional OpenAI API call for secondary opinion
5. **JSON Logging**: Structured events to rotating log files
6. **ELK Pipeline**: Filebeat → Logstash → Elasticsearch
7. **Visualization**: Kibana dashboards and saved searches
8. **Alerting**: ElastAlert monitoring with email/Slack notifications

### Performance

- **Classical ML**: <10ms inference time
- **LLM calls**: 500-800ms with caching and rate limiting
- **Throughput**: 100+ emails/minute in classical mode
- **Storage**: ~1KB per email event in Elasticsearch

## License

MIT License - see LICENSE file for details.
