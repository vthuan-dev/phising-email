# Phishing Detection Alert Rule with Telegram Notifications
name: Phishing Email Detection Alert
type: frequency

# Index to search
index: phish-mail-*

# Alert when we get at least 1 phishing detection
num_events: 1
timeframe:
  minutes: 5

# Search query for high-risk phishing emails
filter:
- bool:
    should:
      - range:
          llm_confidence:
            gte: 0.85
      - range:
          ml_score:
            gte: 0.85
      - bool:
          must:
            - range:
                suspicious_keywords:
                  gte: 2
            - bool:
                should:
                  - range:
                      llm_confidence:
                        gte: 0.6
                  - range:
                      ml_score:
                        gte: 0.6
      - term:
          url_in_blacklist: true

# URL blacklist configuration
blacklist_urls:
  - "secure-banking.vn-verify.com"
  - "vn-verify.com"
  - "secure-banking"

# Alert configuration for Telegram
alert:
- telegram

# Telegram bot configuration
telegram_bot_token: "8346221080:AAGBNYDXHJ5tS_3qGfry_NO6efklFlLpNTY"
telegram_room_id: "5840055926"

# Alert formatting
alert_subject: "🚨 CẢNH BÁO EMAIL LỪA ĐẢO!"
alert_text: |
  🚨 *PHÁT HIỆN EMAIL LỪA ĐẢO* 🚨
  
  📧 *THÔNG TIN EMAIL:*
  • Thời gian: {0}
  • Người gửi: {1}
  • Tiêu đề: {2}
  
  ⚠️ *PHÂN TÍCH RỦI RO:*
  • Độ tin cậy AI: {3}%
  • Phân loại: {4}
  • Từ khóa đáng ngờ: {5}
  • URL trong danh sách đen: {6}
  
  🤖 *GIẢI THÍCH CỦA AI:*
  {7}
  
  📄 *NỘI DUNG EMAIL:*
  {8}
  
  ⚡ *HÀNH ĐỘNG CẦN THIẾT:*
  Vui lòng kiểm tra email này ngay lập tức trong bảng điều khiển bảo mật.
  
  #CảnhBáoLừaĐảo #BảoMậtEmail

alert_text_args:
  - "@timestamp"
  - sender
  - subject
  - llm_confidence
  - llm_label
  - suspicious_keywords
  - url_in_blacklist
  - llm_explanation
  - body_excerpt

# Include these fields in the alert
include:
  - "@timestamp"
  - sender
  - sender_hash
  - subject
  - body_excerpt
  - llm_label
  - llm_confidence
  - llm_explanation
  - ml_score
  - suspicious_keywords
  - url_in_blacklist
  - urls

# Alert suppression (optional)
# Don't alert on the same sender for 30 minutes
realert:
  minutes: 30

# Enhancement for better formatting
generate_kibana_link: true
kibana_url: http://localhost:5601
use_kibana_dashboard: http://localhost:5601/app/dashboards#/view/phishing-dashboard

# Description for documentation
description: >
  This rule monitors for high-confidence phishing emails detected by the 
  Gemini AI model or ML classifier. It sends immediate alerts to Telegram 
  when suspicious emails are detected, including those with:
  - High AI confidence scores (>=85%)
  - High ML scores (>=85%)
  - Multiple suspicious keywords with moderate confidence
  - Blacklisted URLs
